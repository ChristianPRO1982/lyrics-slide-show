<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Chants de veill√©e</title>
  <link rel="icon" sizes="192x192" href="/static/images/Lyrics.png" type="image/png"/>
  <style>
    :root{
      --bg-light:#fdb; --fg-light:#421;
      --bg-dark:#111;  --fg-dark:#aaa;
      --font-size:1.5rem;

      /* Layout */
      --sidebar-w:4rem;     /* largeur de la marge gauche avec ic√¥nes */
      --topbar-h:3.25rem;   /* hauteur de la barre haute */
    }

    [data-theme="light"]{background:var(--bg-light);color:var(--fg-light);}
    [data-theme="dark"] {background:var(--bg-dark); color:var(--fg-dark);}

    body{
      margin:0;padding:1rem;font-size:var(--font-size);line-height:1.4;
      overflow-wrap:anywhere;
      -webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;
    }

    /* Inputs */
    select{ height:2.5rem; }
    [data-theme="light"] select{ background:#fdb;color:#220;border:1px solid #ccc; }
    [data-theme="dark"]  select{ background:#222;color:#ffd;border:1px solid #444; }

    /* Contenu d√©cal√© pour ne pas passer sous les barres fixes */
    .content{
      margin-left:calc(var(--sidebar-w) + 1rem);
      margin-right:2rem;
      padding-top:calc(var(--topbar-h) + 0.5rem);
    }

    /* Panneau coulissant (tiroir) ‚Äî ne conserve que QR, lien, logo */
    #controlPanel{
      position:fixed;top:0;right:0;max-width:80vw;width:400px;height:100vh;padding:1rem;
      border-left:1px solid currentColor;
      transform:translateX(100%);transition:transform .3s ease;
      display:flex;flex-direction:column;gap:1rem;z-index:1200;
    }
    [data-theme="light"] #controlPanel { background-color:rgba(222,222,222,0.8); }
    [data-theme="dark"]  #controlPanel { background-color:rgba(0,0,0,0.8); }
    #controlPanel.open{ transform:translateX(0); }

    /* Barre gauche fixe ‚Äî images cliquables (pas de "gros boutons") */
    #quickControls{
      position:fixed;top:0;left:0;bottom:0;width:var(--sidebar-w);
      display:flex;flex-direction:column;gap:.5rem;align-items:center;justify-content:flex-start;
      padding:.5rem .25rem;z-index:1000;border-right:1px solid currentColor;
    }
    [data-theme="light"] #quickControls{ background:rgba(255,255,255,.35); }
    [data-theme="dark"]  #quickControls{ background:rgba(0,0,0,.35); }

    #quickControls a{
      display:flex; align-items:center; justify-content:center;
      text-decoration:none; outline:none;
      padding:.1rem 0; /* petit padding pour hitbox l√©g√®re */
    }
    #quickControls a:focus-visible{ outline:2px solid currentColor; outline-offset:2px; border-radius:.25rem; }
    #quickControls img{
      width:72%; height:auto; display:block; /* taille relative √† la marge */
      user-drag:none; -webkit-user-drag:none;
    }
    #quickControls a:hover img{ opacity:.9; }

    /* Barre sup√©rieure fixe (select 90% de largeur) */
    #topBar{
      position:fixed;top:0;left:var(--sidebar-w);right:0;height:var(--topbar-h);
      display:flex;align-items:center;justify-content:center;padding:.5rem 1rem;
      z-index:999;border-bottom:1px solid currentColor;
    }
    #topBar select{ width:90%; }  /* demand√© : 90% */

    /* Offset naturel quand on scroll vers une section ou un <hr> sous une topbar fixe */
    main > section,
    #lyrics hr{
      scroll-margin-top: calc(var(--topbar-h) + 0.75rem);
    }

    main>section{ margin:2rem 0; }
  </style>
</head>
<body>
  <!-- Barre gauche fixe : QR (toggle du tiroir), taille texte, th√®me -->
  <nav id="quickControls" aria-label="Contr√¥les rapides (fixes)">
    <!-- 1. Ic√¥ne QR (toggle tiroir) -->
    <a href="#" id="toggleQRDrawer" aria-label="Afficher/masquer le QR code" title="QR code">
      <img src="/static/images/all_lyrics-QR_code.png" alt="">
    </a>
    <!-- 2. Taille + -->
    <a href="#" id="increaseFontLeft" aria-label="Texte plus grand" title="Texte plus grand">
      <img src="/static/images/all_lyrics-size_increase.png" alt="">
    </a>
    <!-- 3. Taille - -->
    <a href="#" id="decreaseFontLeft" aria-label="Texte plus petit" title="Texte plus petit">
      <img src="/static/images/all_lyrics-size_decrease.png" alt="">
    </a>
    <!-- 4. Th√®mes (une seule image) -->
    <a href="#" id="themeToggleLeft" aria-label="Basculer le th√®me" title="Th√®me clair/sombre">
      <img src="/static/images/all_lyrics-themes.png" alt="">
    </a>
  </nav>

  <!-- Barre top fixe : s√©lection de chant -->
  <div id="topBar" aria-label="Navigation (fixe)">
    <select id="songSelectTop" aria-label="Choisir un chant (fixe)"></select>
  </div>

  <!-- Tiroir : QR + lien + logo -->
  <aside id="controlPanel" aria-label="Menu des commandes">
    <button id="closePanel" aria-label="Fermer le menu">‚ùå</button>
    <hr style="width:80%;">
    {% if img_qr_code %}
    <div id="qrBlock" style="margin:1rem 0;text-align:center;">
      <input id="linkToCopy" type="text" value="{{ link_to_copy }}" readonly
             style="width:80%;font-size:1rem;padding:.3rem;">
      <button id="copyLinkBtn" style="margin-left:.5rem;">Copy link / Copier le lien</button>
      <div style="margin-top:.75rem;">
        <img src="data:image/png;base64,{{ img_qr_code }}"
             alt="üì± [ERR35b] Impossible de g√©n√©rer le QR-CODE. Contacter l'administrateur du site."
             style="max-width:60%;height:auto;">
      </div>
    </div>
    {% endif %}
    <center style="margin-top:1rem;">
      {% if song_id %}
      <a href="../../song/{{song_id}}/"><img style="width: 15%;" src="/static/images/Lyrics.png" alt="Logo"></a>
      {% else %}
      <img style="width: 15%;" src="/static/images/Lyrics.png" alt="Logo">
      {% endif %}
    </center>
  </aside>

  <h1 class="content">{{ full_title }}</h1>
  <main id="lyrics" class="content">
    {{ lyrics|safe }}
  </main>

  <script>
  // UI fixe (gauche + haut) + tiroir (QR, lien, logo). Scroll sur <hr> si possible.
  (() => {
    // Th√®me initial selon pr√©f√©rences
    const prefersDark = matchMedia('(prefers-color-scheme: dark)').matches;
    const setThemeAttr = (dark) => {
      document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
    };
    setThemeAttr(prefersDark);

    // Refs DOM
    const controlPanel   = document.getElementById('controlPanel');
    const closePanel     = document.getElementById('closePanel');

    const toggleQRDrawer = document.getElementById('toggleQRDrawer');

    const topSelect  = document.getElementById('songSelectTop');
    const themeLeft  = document.getElementById('themeToggleLeft');
    const incLeft    = document.getElementById('increaseFontLeft');
    const decLeft    = document.getElementById('decreaseFontLeft');

    const sections = [...document.querySelectorAll('main > section')];

    // Construire la liste des chants (haut)
    const buildTopSelect = () => {
      if (!topSelect) return;
      topSelect.innerHTML = '';
      sections.forEach((s, i) => {
        const o = document.createElement('option');
        o.value = s.id;
        o.textContent = s.querySelector('h2')?.textContent || `Chant ${i+1}`;
        topSelect.appendChild(o);
      });
    };
    buildTopSelect();

    // Helpers tiroir
    const isDrawerOpen = () => controlPanel.classList.contains('open');
    const openDrawer   = () => controlPanel.classList.add('open');
    const closeDrawer  = () => controlPanel.classList.remove('open');

    // Helper: trouver l‚Äôancre id√©ale (hr au-dessus du titre si pr√©sent)
    const findScrollAnchor = (sectionEl) => {
      if (!sectionEl) return null;

      // 1) un <hr> √† l‚Äôint√©rieur de la section
      const hrInside = sectionEl.querySelector('hr');
      if (hrInside) return hrInside;

      // 2) sinon, un <hr> juste avant la section
      let prev = sectionEl.previousElementSibling;
      while (prev && (prev.tagName === 'SCRIPT' || prev.tagName === 'STYLE')) {
        prev = prev.previousElementSibling;
      }
      if (prev && prev.tagName === 'HR') return prev;

      // 3) fallback: la section elle-m√™me
      return sectionEl;
    };

    // Navigation depuis la liste (utilise l‚Äôancre calcul√©e)
    topSelect?.addEventListener('change', e => {
      const id = e.target.value;
      const sectionEl = document.getElementById(id);
      const anchor = findScrollAnchor(sectionEl);
      anchor?.scrollIntoView({ behavior: 'smooth', block: 'start', inline: 'nearest' });
      closeDrawer();
    });

    // QR icon : toggle tiroir (ouvre ou ferme)
    toggleQRDrawer?.addEventListener('click', (e) => {
      e.preventDefault();
      if (isDrawerOpen()) {
        closeDrawer();
      } else {
        openDrawer();
        // centrer la zone QR si pr√©sente
        setTimeout(() => {
          const qr = document.getElementById('qrBlock');
          qr?.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 50);
      }
    });

    // Bouton ‚ùå dans le tiroir
    closePanel?.addEventListener('click', () => closeDrawer());

    // Copie du lien (dans le tiroir)
    const copyBtn = document.getElementById('copyLinkBtn');
    if (copyBtn) {
      copyBtn.onclick = function() {
        const input = document.getElementById('linkToCopy');
        if (!input) return;
        input.select();
        input.setSelectionRange(0, 99999);
        document.execCommand('copy');
        this.textContent = 'OK!';
        setTimeout(()=>{ this.textContent = 'Copier le lien'; }, 1500);
      };
    }

    // Th√®me (une seule image d'ic√¥ne, on ne change pas le src)
    const toggleTheme = () => {
      const dark = document.documentElement.getAttribute('data-theme') === 'dark';
      setThemeAttr(!dark);
    };
    themeLeft?.addEventListener('click', (e) => { e.preventDefault(); toggleTheme(); });

    // Taille de police (variable CSS)
    let size = 1.5;
    const applySize = () => document.documentElement.style.setProperty('--font-size', `${size}rem`);
    const inc = () => { if (size < 3)   { size = Math.round((size + 0.1) * 10) / 10; applySize(); } };
    const dec = () => { if (size > 0.8) { size = Math.round((size - 0.1) * 10) / 10; applySize(); } };
    incLeft?.addEventListener('click', (e) => { e.preventDefault(); inc(); });
    decLeft?.addEventListener('click', (e) => { e.preventDefault(); dec(); });
    applySize();
  })();
  </script>
</body>
</html>