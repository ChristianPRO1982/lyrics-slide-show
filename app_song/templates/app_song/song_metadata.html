{% extends "base.html" %}

{% load i18n %}

{% block title %}{% trans "song2dot" %}{{ song.title }}{% endblock title %}
{% block title_h1 %}{{ song.title }}{% if song.status >= 1 %} âœ”ï¸{% endif %}{% if song.status == 2 %} â‰ï¸{% endif %}{% endblock title_h1 %}
{% block bloc1 %}
{% include "common/song_actions.html" %}
{% endblock bloc1 %}
{% block bloc2 %}{% include "common/song_genres.html" %}<hr>{{ song_lyrics|safe }}{% endblock bloc2 %}

{% block content %}
<h2 class="L_H2">{{ song.sub_title }}</h2>
<h3 class="L_H3">{% trans "Metadata" %}</h3>
<form method="post" action="{% url "song_metadata" song.song_id %}">
    {% csrf_token %}
    <input name="btn_save" value="{% trans "save" %}" type="submit" />

    <hr>

    <h4 class="L_H4">ğŸ”— {% trans "Web links" %}</h4>

    <table>
        <thead>
            <tr>
                <th style="width: 40%;">{% trans "Link" %}</th>
                <th style="width: 40%;">{% trans "Auto-text" %}</th>
                <th style="width: 20%;">{% trans "Actions" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for link in song.links %}
            <tr>
                <td><input name="txt_link_{{ forloop.counter }}" value="{{ link.0 }}"></td>
                <td><input value="{{ link.1 }}" readonly="readonly"></td>
                <td>
                    <input onclick="return confirm('{% trans "Delete this link?" %}');"
                    name="btn_delete_link_{{ forloop.counter }}" value="â›“ï¸â€ğŸ’¥ {% trans "Delete" %}" type="submit" />
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" rowspan="1">{% trans "New link" %}</td>
            </tr>
            <tr>
                <td colspan="3" rowspan="1"><input name="txt_new_link"></td>
            </tr>
            <tr>
                <th>{% trans "Link" %}</th>
                <th>{% trans "Auto-text" %}</th>
                <th>{% trans "Actions" %}</th>
            </tr>
        </tfoot>
    </table>

    <hr>

    <h3 class="L_H3">{% trans "Genre" %}</h3>
    <div class="genre-selection-container" style="display: flex; gap: 2em;">
        <div style="flex: 1;">
            <h4 class="L_H4">{% trans "Associated genres" %}</h4>
            <ul id="associated-genres" class="genre-list" style="height: 15em; overflow: auto; border: 1px solid #ccc; padding: 8px;">
                {% for genre in genres_associated %}
                <li class="genre-item" 
                    data-genre-id="{{ genre.genre_id }}" 
                    draggable="true"
                    ondblclick="moveGenre(this, 'not-associated-genres')">
                    <input type="hidden" name="genre_ids" value="{{ genre.genre_id }}">
                    <strong>{{ genre.group }}</strong> â€“ {{ genre.name }}
                </li>
                {% endfor %}
            </ul>
        </div>
        <div style="flex: 1;">
            <h4 class="L_H4">{% trans "Available genres" %}</h4>
            <ul id="not-associated-genres" class="genre-list" style="height: 15em; overflow: auto; border: 1px solid #ccc; padding: 8px;">
                {% for genre in genres_not_associated %}
                <li class="genre-item" 
                    data-genre-id="{{ genre.genre_id }}" 
                    draggable="true"
                    ondblclick="moveGenre(this, 'associated-genres')">
                    <strong>{{ genre.group }}</strong> â€“ {{ genre.name }}
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <script>
    function moveGenre(item, targetId) {
        document.getElementById(targetId).appendChild(item);
        updateGenreInputs();
    }

    document.querySelectorAll('.genre-list').forEach(list => {
        list.addEventListener('dragover', function(e) {
            e.preventDefault();
        });
        list.addEventListener('drop', function(e) {
            e.preventDefault();
            const genreId = e.dataTransfer.getData('text/plain');
            const item = document.querySelector('.genre-item[data-genre-id="' + genreId + '"]');
            if (item && item.parentNode !== this) {
                this.appendChild(item);
                updateGenreInputs();
            }
        });
    });

    document.querySelectorAll('.genre-item').forEach(item => {
        item.addEventListener('dragstart', function(e) {
            e.dataTransfer.setData('text/plain', this.dataset.genreId);
        });
    });

    function updateGenreInputs() {
        // Remove all hidden inputs from all genre items
        document.querySelectorAll('.genre-item input[type="hidden"]').forEach(e => e.remove());

        // Add hidden inputs only to associated genres
        document.querySelectorAll('#associated-genres .genre-item').forEach(item => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'genre_ids';
            input.value = item.dataset.genreId;
            item.appendChild(input);
        });
    }
    </script>
    <style>
    .genre-list { list-style: none; margin: 0; padding: 0; min-height: 2em; }
    .genre-item { color: #000000; background: #777777; margin: 2px 0; padding: 4px 8px; border-radius: 4px; cursor: grab; }
    .genre-item:active { color: #000000; background: #aaaaaa; }
    </style>

    <br><hr>
    <h3 class="L_H3">{% trans "Bands ans artists" %}</h3>
    <div style="display: flex; gap: 1em;">
        <h4 class="L_H4" style="flex: 1;">{% trans "Bands" %}</h4>
        <h4 class="L_H4" style="flex: 1;">{% trans "Artists" %}</h4>
    </div>
    <div style="display: flex; gap: 1em; height: 15em;">
        <div style="flex: 1; height: 15em;">
            <ul>
                {% for band in bands %}
                <li>
                    <label>
                        <input style="width: 10%;" type="checkbox" name="band_ids" value="{{ band.band_id }}"
                        {% if band.song_id >= 1 %}checked="checked"{% endif %}>
                        {{ band.name }}
                    </label>
                </li>
                {% endfor %}
            </ul>
        </div>
        <div style="flex: 1; height: 15em;">
        </div>
    </div>

    {% if moderator %}
    <br><hr>
    <h3 class="L_H3">{% trans "Moderator" %}</h3>
    <h4 class="L_H4">{% trans "Genre" %}</h4>
    <table>
        <thead>
            <tr>
                <th style="width: 40%;">{% trans "Group" %}</th>
                <th style="width: 40%;">{% trans "Name" %}</th>
                <th style="width: 20%;">{% trans "Actions" %}</th>
            </tr>
        </thead>
        <tbody>
            {% for genre in genres %}
            <tr>
                <td><input name="txt_genre_group_{{ genre.genre_id }}" value="{{ genre.full_group }}"></td>
                <td><input name="txt_genre_name_{{ genre.genre_id }}" value="{{ genre.full_name }}"></td>
                <td>
                    <input type="checkbox" name="chk_delete_genre_{{ genre.genre_id }}" id="chk_delete_genre_{{ genre.genre_id }}" style="width: 10%">
                    <label for="chk_delete_genre_{{ genre.genre_id }}">
                        <span class="icon">ğŸ—‘ï¸</span>
                        {% trans "Delete" %}
                    </label>
                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td><input name="txt_genre_group_NEW" placeholder="{% trans "Group name" %}"></td>
                <td><input name="txt_genre_name_NEW" placeholder="{% trans "Genre name" %}"></td>
                <td>{% trans "New genre" %}</td>
            </tr>
            <tr>
                <th>{% trans "Group" %}</th>
                <th>{% trans "Name" %}</th>
                <th>{% trans "Actions" %}</th>
            </tr>
        </tfoot>
    </table>
    {% endif %}

    <hr>

    <input name="btn_save" value="{% trans "save" %}" type="submit" />
</form>
{% endblock content %}